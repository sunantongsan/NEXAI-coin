<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>NEXAI Web Wallet - Demo (LocalStorage + Seed + Balance)</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    .card { border: 1px solid #ccc; padding: 16px; border-radius: 12px; margin-bottom: 20px; }
    input, button { padding: 10px; width: 100%; margin: 5px 0; }
    button { cursor: pointer; }
    .log { white-space: pre-wrap; background: #f7f7f7; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>NEXAI Web Wallet - Demo</h1>

  <div class="card">
    <h2>สร้างกระเป๋าใหม่</h2>
    <button onclick="createWallet()">สร้างกระเป๋า</button>
    <div id="createResult"></div>
  </div>

  <div class="card">
    <h2>กู้กระเป๋าเก่า (ใส่ Seed)</h2>
    <input id="seedInput" placeholder="ใส่ Seed ของคุณ" />
    <button onclick="loadWalletFromSeed()">โหลดกระเป๋า</button>
    <div id="walletInfo"></div>
  </div>

  <div class="card">
    <h2>รับเหรียญ (Address)</h2>
    <div id="addrBox">กรุณาโหลดหรือสร้างกระเป๋าก่อน</div>
    <p id="balanceDisplay">ยอดเหรียญ: 0 NXI</p>
    <p id="valueDisplay">มูลค่า: 0 บาท</p>
  </div>

  <div class="card">
    <h2>ส่งเหรียญ</h2>
    <input id="toAddress" placeholder="Address ผู้รับ" />
    <input id="amount" placeholder="จำนวน NXI" type="number" />
    <button onclick="sendCoin()">ส่งเหรียญ</button>
    <div id="sendResult"></div>
  </div>

  <div class="card">
    <h2>เติมเหรียญ Demo</h2>
    <button onclick="mintDemo()">Mint 1,000,000 NXI ให้ demo address</button>
  </div>

  <div class="card">
    <h2>ประวัติธุรกรรม</h2>
    <div class="log" id="logBox">— ไม่มีข้อมูล —</div>
  </div>

<script>
let wallet = null;
let chain = { balances: {}, logs: [] };
const NXI_PRICE = 10; // ราคาตั้งต้น 1 NXI = 10 บาท

function randHex(n) {
  const hex = '0123456789abcdef';
  let out = '';
  for (let i = 0; i < n; i++) out += hex[Math.floor(Math.random()*16)];
  return out;
}

// ===== LocalStorage Functions =====
function saveWallet() { if(wallet) localStorage.setItem('wallet', JSON.stringify(wallet)); }
function loadWalletFromStorage() {
  const w = localStorage.getItem('wallet');
  if(w){
    wallet = JSON.parse(w);
    document.getElementById('walletInfo').innerHTML = `<b>Address:</b> ${wallet.address}<br><b>Seed:</b> ${wallet.seed}`;
    document.getElementById('addrBox').innerText = wallet.address;
    updateBalance();
  }
}

function saveChain() { localStorage.setItem('chain', JSON.stringify(chain)); }
function loadChainFromStorage() {
  const c = localStorage.getItem('chain');
  if(c) chain = JSON.parse(c);
  updateLogs();
  updateBalance();
}

window.onload = function() {
  loadWalletFromStorage();
  loadChainFromStorage();
}

// ===== Wallet Functions =====
function createWallet() {
  const w = { network: "NEXAI-NXI", address: randHex(40), seed: randHex(64) };
  wallet = w;
  document.getElementById('createResult').innerHTML = `<p><b>Address:</b> ${w.address}</p><p><b>Seed:</b> ${w.seed}</p>`;
  document.getElementById('addrBox').innerText = w.address;
  if (!chain.balances[w.address]) chain.balances[w.address] = 0;
  saveWallet();
  saveChain();
  updateBalance();
}

function loadWalletFromSeed() {
  const seed = document.getElementById('seedInput').value.trim();
  if(!seed) return alert("กรุณาใส่ Seed");

  wallet = {
    network: "NEXAI-NXI",
    seed: seed,
    address: seedToAddress(seed)
  };

  document.getElementById('walletInfo').innerHTML = `<b>Address:</b> ${wallet.address}<br><b>Seed:</b> ${wallet.seed}`;
  document.getElementById('addrBox').innerText = wallet.address;
  if(!chain.balances[wallet.address]) chain.balances[wallet.address] = 0;

  saveWallet();
  saveChain();
  updateBalance();
  alert("โหลด wallet เรียบร้อยแล้ว");
}

function seedToAddress(seed) {
  let hash = 0;
  for (let i = 0; i < seed.length; i++) {
    hash = ((hash << 5) - hash) + seed.charCodeAt(i);
    hash = hash & hash;
  }
  return ('0000000000000000000000000000000000000000' + (hash>>>0).toString(16)).slice(-40);
}

function loadWallet() {
  const file = document.getElementById('loadJson').files[0];
  if (!file) return alert("กรุณาเลือกไฟล์ .json");
  const reader = new FileReader();
  reader.onload = e => {
    wallet = JSON.parse(e.target.result);
    document.getElementById('walletInfo').innerHTML = `<b>Address:</b> ${wallet.address}<br><b>Seed:</b> ${wallet.seed}`;
    document.getElementById('addrBox').innerText = wallet.address;
    if (!chain.balances[wallet.address]) chain.balances[wallet.address] = 0;
    saveWallet();
    saveChain();
    updateBalance();
  };
  reader.readAsText(file);
}

function sendCoin() {
  if (!wallet) return alert("กรุณาโหลดหรือสร้างกระเป๋าก่อน");
  const to = document.getElementById('toAddress').value.trim();
  const amount = parseFloat(document.getElementById('amount').value);
  if (!to || isNaN(amount) || amount <= 0) return alert("ข้อมูลไม่ถูกต้อง");
  const from = wallet.address;
  if (!chain.balances[from]) chain.balances[from] = 0;
  if (!chain.balances[to]) chain.balances[to] = 0;
  if (chain.balances[from] < amount) return alert("ยอดเงินไม่พอ");
  chain.balances[from] -= amount;
  chain.balances[to] += amount;
  const tx = { id: randHex(32), from, to, amount, time: new Date().toLocaleString() };
  chain.logs.push(tx);
  document.getElementById('sendResult').innerHTML = `<p>TX ID: ${tx.id}</p>`;
  updateLogs();
  saveChain();
  updateBalance();
}

function mintDemo() {
  const demoAddress = "0000000000000000000000000000000004396b9c";
  const amount = 1000000;
  if (!chain.balances[demoAddress]) chain.balances[demoAddress] = 0;
  chain.balances[demoAddress] += amount;
  const tx = { id: randHex(32), from: "SYSTEM", to: demoAddress, amount: amount, time: new Date().toLocaleString() };
  chain.logs.push(tx);
  updateLogs();
  saveChain();
  updateBalance();
  alert(`มิ้น 1,000,000 NXI ให้ Address ${demoAddress} เรียบร้อยแล้ว`);
}

function updateLogs() {
  const log = chain.logs.map(l => `TX ${l.id}\nจาก: ${l.from}\nไป: ${l.to}\nจำนวน: ${l.amount} NXI\nเวลา: ${l.time}\n`).join("\n---------------------\n\n");
  document.getElementById('logBox').innerText = log || "— ไม่มีข้อมูล —";
}

function updateBalance() {
    if(wallet && chain.balances[wallet.address] !== undefined) {
        const balance = chain.balances[wallet.address];
        document.getElementById('balanceDisplay').innerText = `ยอดเหรียญ: ${balance} NXI`;
        document.getElementById('valueDisplay').innerText = `มูลค่า: ${balance * NXI_PRICE} บาท`;
    }
}
</script>

</body>
</html>
